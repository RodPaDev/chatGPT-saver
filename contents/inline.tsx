import cssText from 'data-text:~style.css'
import type { PlasmoContentScript, PlasmoGetInlineAnchor } from 'plasmo'
import type { SyntheticEvent } from 'react'

import '../style.css'

import { downloadFile, getConversationThread } from './utils'

export const config: PlasmoContentScript = {
  matches: ['https://chat.openai.com/chat']
}

export const getStyle = () => {
  const style = document.createElement('style')
  style.textContent = cssText
  return style
}

export const getInlineAnchor: PlasmoGetInlineAnchor = async () =>
  document.querySelector('nav > a:last-child')

function PlasmoInline() {
  const saveThread = (e: SyntheticEvent) => {
    e.preventDefault()
    const nodeWrapper = document.querySelector(
      '[class*="ThreadLayout__NodeWrapper"]'
    )

    const conversationItems = Array.from(nodeWrapper.children).filter(
      ({ className }) => className.includes('ConversationItem')
    )

    const thread = getConversationThread(conversationItems)

    const markdownString = thread.reduce(
      (str, bubble, index, array) =>
        (str += `Sender: ${bubble.sender}\n\nMessage:\n${bubble.content}\n\n${
          index < array.length - 1 ? '---\n' : ''
        }`),
      ''
    )

    downloadFile(markdownString)
  }

  return (
    <div className="w-full py-1 flex flex-col items-center gap-2 justify-center mt-5">
      <button
        onClick={saveThread}
        className="bg-green-400 text-gray-800 hover:bg-green-500 font-bold py-2 px-4 text-sm rounded inline-flex items-center transition-colors duration-200">
        <svg
          className="w-4 h-4 mr-2"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 20 20"
          fill="currentColor">
          <path d="M13 8V2H7v6H2l8 8 8-8h-5zM0 18h20v2H0v-2z" />
        </svg>
        <span>Save Conversation</span>
      </button>
      <a
        className="text-xs text-white/50 flex items-center gap-1 underline transition-colors duration-200 hover:text-white/75 underline-offset-2"
        href="https://github.com/RodPaDev/chatGPT-save/issues/new?assignees=&labels=&template=bug_report.md&title=">
        <svg
          className="w-4 h-4"
          viewBox="0 0 514 466"
          fill="none"
          xmlns="http://www.w3.org/2000/svg">
          <path
            d="M499.667 267.667H405V217C405 215.984 405.313 214.964 405.291 213.945C453.4 208.927 481 177.272 481 125.333V113.333C481 105.969 475.029 100 467.667 100C460.305 100 454.334 105.969 454.334 113.333V125.333C454.334 163.732 437.329 184.154 402.449 187.5C396.38 160.475 381.574 137.119 356.912 131.8C353.167 103.26 335.499 79.111 310.797 66.573C321.118 56.072 327.668 41.686 327.668 25.833V14C327.668 6.63599 321.697 0.666992 314.335 0.666992C306.973 0.666992 301 6.63599 301 14V25.833C301 43.203 286.536 57 269.167 57H246.167C228.798 57 214.334 43.203 214.334 25.833V14C214.334 6.63599 208.363 0.666992 201.001 0.666992C193.639 0.666992 187.667 6.63599 187.667 14V25.833C187.667 41.686 194.216 56.072 204.538 66.574C179.837 79.111 162.085 103.261 158.339 131.801C133.644 137.125 118.874 160.537 112.82 187.609C77.061 184.649 59.667 164.206 59.667 125.333V113.333C59.667 105.969 53.696 100 46.334 100C38.972 100 33 105.969 33 113.333V125.333C33 177.748 60.439 209.501 109.375 214.072C109.353 215.048 109 216.025 109 217V267.667H14.333C6.971 267.667 1 273.636 1 281C1 288.364 6.971 294.333 14.333 294.333H109V317.333C109 327.961 110.469 338.326 112.608 348.325C61.659 351.777 33 383.773 33 437.333V449.333C33 456.697 38.971 462.666 46.333 462.666C53.695 462.666 59.666 456.697 59.666 449.333V437.333C59.666 395.538 79.817 375.042 121.231 374.684C143.682 427.892 196.382 465.333 257.666 465.333C318.942 465.333 371.637 427.901 394.091 374.704C434.61 375.488 454.332 395.987 454.332 437.333V449.333C454.332 456.697 460.303 462.666 467.665 462.666C475.027 462.666 481 456.697 481 449.333V437.333C481 384.233 452.177 352.32 402.04 348.412C404.191 338.387 405 327.991 405 317.333V294.333H499.667C507.03 294.333 513 288.364 513 281C513 273.636 507.029 267.667 499.667 267.667ZM243.667 437.855C183.334 430.891 135.667 379.502 135.667 317.334V217C135.667 196.207 142.615 166.469 160.15 158.965C166.777 177.333 184.71 190.333 205.334 190.333H243.667V437.855ZM205.333 163.667C193.753 163.667 184.333 154.247 184.333 142.667C184.333 110.135 210.801 83.667 243.333 83.667H272C304.532 83.667 331 110.135 331 142.667C331 154.247 321.58 163.667 310 163.667H205.333ZM378.333 317.333C378.333 379.96 331.306 431.653 270.333 438.006V190.333H310C330.624 190.333 347.891 177.333 354.517 158.965C372.052 166.469 378.333 196.206 378.333 217V317.333Z"
            fill="currentColor"
          />
          <path
            d="M162 413L236.5 452H288.5L351 413L391 354.5L397.5 241L380.5 160L333 119L288.5 71L207 83L170.5 140.5L124 185V322L162 413Z"
            fill="currentColor"
          />
          <path
            d="M499.667 267.667H405V217C405 215.984 405.313 214.964 405.291 213.945C453.4 208.927 481 177.272 481 125.333V113.333C481 105.969 475.029 100 467.667 100C460.305 100 454.334 105.969 454.334 113.333V125.333C454.334 163.732 437.329 184.154 402.449 187.5C396.38 160.475 381.574 137.119 356.912 131.8C353.167 103.26 335.499 79.111 310.797 66.573C321.118 56.072 327.668 41.686 327.668 25.833V14C327.668 6.63599 321.697 0.666992 314.335 0.666992C306.973 0.666992 301 6.63599 301 14V25.833C301 43.203 286.536 57 269.167 57H246.167C228.798 57 214.334 43.203 214.334 25.833V14C214.334 6.63599 208.363 0.666992 201.001 0.666992C193.639 0.666992 187.667 6.63599 187.667 14V25.833C187.667 41.686 194.216 56.072 204.538 66.574C179.837 79.111 162.085 103.261 158.339 131.801C133.644 137.125 118.874 160.537 112.82 187.609C77.061 184.649 59.667 164.206 59.667 125.333V113.333C59.667 105.969 53.696 100 46.334 100C38.972 100 33 105.969 33 113.333V125.333C33 177.748 60.439 209.501 109.375 214.072C109.353 215.048 109 216.025 109 217V267.667H14.333C6.971 267.667 1 273.636 1 281C1 288.364 6.971 294.333 14.333 294.333H109V317.333C109 327.961 110.469 338.326 112.608 348.325C61.659 351.777 33 383.773 33 437.333V449.333C33 456.697 38.971 462.666 46.333 462.666C53.695 462.666 59.666 456.697 59.666 449.333V437.333C59.666 395.538 79.817 375.042 121.231 374.684C143.682 427.892 196.382 465.333 257.666 465.333C318.942 465.333 371.637 427.901 394.091 374.704C434.61 375.488 454.332 395.987 454.332 437.333V449.333C454.332 456.697 460.303 462.666 467.665 462.666C475.027 462.666 481 456.697 481 449.333V437.333C481 384.233 452.177 352.32 402.04 348.412C404.191 338.387 405 327.991 405 317.333V294.333H499.667C507.03 294.333 513 288.364 513 281C513 273.636 507.029 267.667 499.667 267.667ZM243.667 437.855C183.334 430.891 135.667 379.502 135.667 317.334V217C135.667 196.207 142.615 166.469 160.15 158.965C166.777 177.333 184.71 190.333 205.334 190.333H243.667V437.855ZM205.333 163.667C193.753 163.667 184.333 154.247 184.333 142.667C184.333 110.135 210.801 83.667 243.333 83.667H272C304.532 83.667 331 110.135 331 142.667C331 154.247 321.58 163.667 310 163.667H205.333ZM378.333 317.333C378.333 379.96 331.306 431.653 270.333 438.006V190.333H310C330.624 190.333 347.891 177.333 354.517 158.965C372.052 166.469 378.333 196.206 378.333 217V317.333Z"
            stroke="currentColor"
          />
          <path
            d="M162 413L236.5 452H288.5L351 413L391 354.5L397.5 241L380.5 160L333 119L288.5 71L207 83L170.5 140.5L124 185V322L162 413Z"
            stroke="currentColor"
          />
        </svg>

        <span> Report extension bug</span>
      </a>

      <a
        className="text-xs text-white flex items-center gap-1 hover:text-amber-500 transition-colors duration-200 mt-8 underline underline-offset-2"
        href="https://github.com/sponsors/RodPaDev">
        🍣 Gift my cat some tuna
      </a>
    </div>
  )
}

export default PlasmoInline
